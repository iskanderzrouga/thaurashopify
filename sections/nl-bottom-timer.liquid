{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top_m }}px;
    padding-bottom: {{ section.settings.padding_bottom_m }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div id="{{ section.settings.section_id }}" class="section-{{ section.id }}-padding px-5 relative" style="background-color: {{ section.settings.bgcolor }};">
  <div class="w-full flex justify-center items-center" style="padding-top: 0; padding-bottom: 20px;">
    {% if section.settings.show_timer %}
      <div class="-mb-10 relative z-1" style="background: #f6f7ef; border: 1px dashed #247042; border-radius: 7px; padding: 8px 12px; display: inline-flex;">
        <div class="flex items-center gap-1.5 md:gap-2">
          <span class="text-black font-medium" style="font-size: 14px; line-height: 1.4;">Offer Expires in:</span>
          <div class="flex items-center gap-1">
            <div class="timer-hours-{{ section.id }}" style="background: #247042; color: white; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 500;">00</div>
            <span class="text-black font-medium" style="font-size: 14px; line-height: 1.4;">:</span>
            <div class="timer-minutes-{{ section.id }}" style="background: #247042; color: white; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 500;">00</div>
            <span class="text-black font-medium" style="font-size: 14px; line-height: 1.4;">:</span>
            <div class="timer-seconds-{{ section.id }}" style="background: #247042; color: white; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 500;">00</div>
          </div>
        </div>
      </div>
      <style>
        @media screen and (min-width: 750px) {
          #{{ section.settings.section_id }} .flex.items-center.gap-1\.5 {
            gap: 0.5rem;
          }
          #{{ section.settings.section_id }} .text-black.font-medium {
            font-size: 20px !important;
          }
          #{{ section.settings.section_id }} .timer-hours-{{ section.id }},
          #{{ section.settings.section_id }} .timer-minutes-{{ section.id }},
          #{{ section.settings.section_id }} .timer-seconds-{{ section.id }} {
            width: 30px !important;
            height: 30px !important;
            font-size: 18px !important;
            border-radius: 5px !important;
          }
          #{{ section.settings.section_id }} .flex.items-center.gap-1\.5.md\:gap-2 > div {
            padding: 10px 20px;
          }
        }
      </style>
    {% endif %}
  </div>

  {% if section.settings.show_timer %}
    <script>
      (function() {
        const sectionId = '{{ section.id }}';
        const timerHours = document.querySelector('.timer-hours-' + sectionId);
        const timerMinutes = document.querySelector('.timer-minutes-' + sectionId);
        const timerSeconds = document.querySelector('.timer-seconds-' + sectionId);
        
        let totalSeconds = ({{ section.settings.timer_hours | default: 0 }} * 3600) + 
                          ({{ section.settings.timer_minutes | default: 0 }} * 60) + 
                          {{ section.settings.timer_seconds | default: 0 }};
        
        function updateTimer() {
          if (totalSeconds <= 0) {
            totalSeconds = ({{ section.settings.timer_hours | default: 0 }} * 3600) + 
                          ({{ section.settings.timer_minutes | default: 0 }} * 60) + 
                          {{ section.settings.timer_seconds | default: 0 }};
          }
          
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          
          if (timerHours) timerHours.textContent = String(hours).padStart(2, '0');
          if (timerMinutes) timerMinutes.textContent = String(minutes).padStart(2, '0');
          if (timerSeconds) timerSeconds.textContent = String(seconds).padStart(2, '0');
          
          totalSeconds--;
        }
        
        updateTimer();
        const interval = setInterval(updateTimer, 1000);
      })();
    </script>
  {% endif %}

  <div
    class="mx-auto w-full max-w-[1420px] flex flex-col items-center justify-center gap-8 relative"
    style="max-width: {{ section.settings.max_width }}px; border-radius: 24px; background: {{ section.settings.bg_color }}; overflow: hidden;"
  >
    {% if section.settings.bg_img != blank %}
      {{
        section.settings.bg_img
        | image_url: width: 1140
        | image_tag: class: 'absolute bottom-0 left-0 w-full object-cover h-full rounded-[24px]', sizes: '1140px'
      }}
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-5 items-center gap-6 md:gap-12 relative">
      <div class="col-span-1 md:col-span-2 hidden md:block">
        {% if section.settings.img != blank %}
          {{
            section.settings.img
            | image_url: width: 600
            | image_tag: class: 'w-full max-w-[450px] mx-auto hidden md:block md:pl-10', sizes: '600px'
          }}
        {% endif %}
      </div>

      <div class="col-span-1 md:col-span-3 w-full px-4 py-6 md:px-10 md:py-10">
        <div
          class="flex flex-col justify-center items-center md:items-center gap-5 md:gap-6 text-center"
        >
          {% if section.settings.heading != blank %}
            <h2
              class="text-[28px] md:text-[36px] lg:text-[38px] font-bold !leading-[1.2] text-[#fff]"
              style="color: {{ section.settings.text_color }};"
            >
              {{ section.settings.heading }}
            </h2>
          {% endif %}

          {% if section.settings.img_mobile != blank %}
            {{
              section.settings.img_mobile
              | image_url: width: 380
              | image_tag: class: 'w-full max-w-[280px] mx-auto block md:hidden', sizes: '380px'
            }}
          {% endif %}

          {% if section.settings.description != blank %}
            <div class="text-[20px] md:text-[24px] font-bold !leading-[1.4]">
              <span style="color: {{ section.settings.offer_color }};">{{ section.settings.description | split: '(' | first }}</span>
              <span style="color: {{ section.settings.text_color }};">{% if section.settings.description contains '(' %}({{ section.settings.description | split: '(' | last }}{% endif %}</span>
            </div>
          {% endif %}

          <!-- 4 Icons Grid -->
          {% if section.blocks.size > 0 %}
            <div class="flex flex-wrap justify-center items-start gap-4 md:gap-8 w-full max-w-[600px] mx-auto mt-2">
              {% for block in section.blocks %}
                <div class="flex flex-col items-center gap-2.5 w-[calc(50%-8px)] md:w-auto" {{ block.shopify_attributes }}>
                  <div style="width: 48px; height: 48px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    {% if block.settings.icon != blank %}
                      {{
                        block.settings.icon
                        | image_url: width: 28
                        | image_tag: class: 'w-5 h-5 md:w-6 md:h-6 object-contain', sizes: '28px'
                      }}
                    {% endif %}
                  </div>
                  {% if block.settings.text != blank %}
                    <p class="text-[11px] md:text-[12px] font-normal !leading-[1.3] text-white text-center" style="max-width: 90px; word-wrap: break-word;">
                      {{ block.settings.text }}
                    </p>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="w-full flex flex-col items-center md:items-center justify-center gap-[10px] relative mt-2">
            {% if section.settings.button_label != blank %}
              <div class="w-full max-w-[520px] mx-auto">
                <button 
                  type="button"
                  class="add-to-cart-checkout-{{ section.id }}"
                  data-variant-id="{{ section.settings.product_variant_id }}"
                  style="display: inline-flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 16px 32px; background: white; color: #084c25; font-size: 20px; font-weight: 700; text-decoration: none; border-radius: 100px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; line-height: 24px; border: none; cursor: pointer;"
                >
                  <span class="button-text-{{ section.id }}">{{ section.settings.button_label }}</span>
                  <svg class="button-arrow-{{ section.id }}" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 1L15 8L8 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 8H1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <svg class="button-spinner-{{ section.id }}" style="display: none; animation: spin 1s linear infinite;" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-opacity="0.25"/>
                    <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            {% endif %}

            {% if section.settings.product_bottom_label != blank %}
              <div class="flex items-center gap-2 mt-3 md:mt-3 relative w-fit mx-auto">
                {% if section.settings.bottom_label_icon != blank %}
                  {{
                    section.settings.bottom_label_icon
                    | image_url: width: 20
                    | image_tag: class: 'w-full max-w-[18px] md:max-w-[20px]'
                  }}
                {% endif %}

                <div
                  class="text-[14px] md:text-[15px] font-normal !leading-tight"
                  style="color: {{ section.settings.text_color }};"
                >
                  {{ section.settings.product_bottom_label }}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const addToCartBtn = document.querySelector('.add-to-cart-checkout-{{ section.id }}');
    
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const variantId = this.getAttribute('data-variant-id');
        const buttonText = document.querySelector('.button-text-{{ section.id }}');
        const buttonArrow = document.querySelector('.button-arrow-{{ section.id }}');
        const buttonSpinner = document.querySelector('.button-spinner-{{ section.id }}');
        
        if (!variantId) {
          alert('Please select a product variant in theme settings');
          return;
        }
        
        // Show loading state
        if (buttonText) buttonText.style.display = 'none';
        if (buttonArrow) buttonArrow.style.display = 'none';
        if (buttonSpinner) buttonSpinner.style.display = 'block';
        addToCartBtn.disabled = true;
        
        // Add to cart using Shopify Ajax API
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: variantId,
              quantity: 1
            }]
          })
        })
        .then(response => response.json())
        .then(data => {
          // Redirect to checkout
          window.location.href = '/checkout';
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to add product to cart. Please try again.');
          
          // Reset button state
          if (buttonText) buttonText.style.display = 'inline';
          if (buttonArrow) buttonArrow.style.display = 'block';
          if (buttonSpinner) buttonSpinner.style.display = 'none';
          addToCartBtn.disabled = false;
        });
      });
    }
  });
</script>

<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  
  .add-to-cart-checkout-{{ section.id }}:hover {
    opacity: 0.9;
    transform: scale(1.02);
  }
  
  .add-to-cart-checkout-{{ section.id }}:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
</style>

{% schema %}
{
  "name": "NL Bottom Timer",
  "settings": [
    {
      "type": "text",
      "id": "section_id",
      "label": "Section ID"
    },
    {
      "type": "checkbox",
      "id": "show_timer",
      "label": "Show Timer",
      "default": false
    },
    {
      "type": "range",
      "id": "timer_hours",
      "min": 0,
      "max": 48,
      "step": 1,
      "label": "Timer Hours",
      "default": 0
    },
    {
      "type": "range",
      "id": "timer_minutes",
      "min": 0,
      "max": 59,
      "step": 1,
      "label": "Timer Minutes",
      "default": 30
    },
    {
      "type": "range",
      "id": "timer_seconds",
      "min": 0,
      "max": 59,
      "step": 1,
      "label": "Timer Seconds",
      "default": 0
    },
    {
      "type": "image_picker",
      "id": "img",
      "label": "Image"
    },
    {
      "type": "image_picker",
      "id": "img_mobile",
      "label": "Image (Mobile)"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description (Offer Text)"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button URL (Not used - using Add to Cart)"
    },
    {
      "type": "text",
      "id": "product_variant_id",
      "label": "Product Variant ID",
      "info": "Enter the variant ID to add to cart and redirect to checkout"
    },
    {
      "type": "text",
      "id": "product_bottom_label",
      "label": "Product Bottom Label"
    },
    {
      "type": "image_picker",
      "id": "bottom_label_icon",
      "label": "Bottom Label Icon"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "offer_color",
      "label": "Offer Text Color",
      "default": "#FF8C42"
    },
    {
      "type": "color",
      "id": "bgcolor",
      "label": "Outer Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Card Background Color",
      "default": "#1a4d3e"
    },
    {
      "type": "image_picker",
      "id": "bg_img",
      "label": "Background Image"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 600,
      "max": 1800,
      "step": 20,
      "unit": "px",
      "label": "Max Width",
      "default": 1200
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding Top",
      "default": 72
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 72
    },
    {
      "type": "range",
      "id": "padding_top_m",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding Top (Mobile)",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom_m",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding Bottom (Mobile)",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "icon",
      "name": "Icon",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "NL Bottom Timer"
    }
  ]
}
{% endschema %}

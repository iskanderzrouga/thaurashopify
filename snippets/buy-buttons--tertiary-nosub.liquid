{% comment %}
  Renders product buy-buttons.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.
  - show_pickup_availability: {Boolean} for the pickup availability. If true the pickup availability is rendered, false - not rendered (optional).

  Usage:
  {% render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true %}
{% endcomment %}

<div class="nl-product-variants__variant-wrapper nl-product-variants__variant-wrapper-{{index}} {% unless index == section.settings.default_index %} md:py-8 {% endunless %}">
  <div class="nl-product-variants__variant nl-product-variants__variant-{{index}} {% if index == section.settings.default_index %} active bg-[#E8F4B5] {% else %} bg-white inactive {% endif %} h-full group [&.active]:opacity-100 [&.inactive]:opacity-70 cursor-pointer duration-100 w-full border border-[#3F5348] rounded-[12px] flex flex-col gap-5 pb-6">
    <div
      class="px-5 flex flex-col items-center justify-center gap-1 text-center p-4 rounded-[9px] duration-100"
      style="background-color: {{ current_variant.metafields.custom.badge_background }};"
    >
      {% if current_variant.metafields.custom.badge %}
        <div
          class="text-[26px] md:text-[34px] font-bold !leading-tight duration-100"
          style="color: {{ current_variant.metafields.custom.badge_color }};"
        >
          {{ current_variant.metafields.custom.badge }}
        </div>
      {% endif %}
      {% if current_variant.metafields.custom.badge_description %}
        <div
          class="text-[17px] md:text-[20px] font-medium !leading-tight duration-100 {% if index == section.settings.default_index %} !text-[#EBA12F] {% endif %}"
          style="color: {{ current_variant.metafields.custom.badge_color }};"
        >
          {{ current_variant.metafields.custom.badge_description }}
        </div>
      {% endif %}
    </div>

    <div class="px-5 flex justify-center {% if index == section.settings.default_index %} md:mt-8 {% endif %}">
      {% if current_variant.metafields.custom.custom_variant_image != blank %}
        <div class="relative w-fit">
          {{
            current_variant.metafields.custom.custom_variant_image
            | image_url: width: 300
            | image_tag: class: 'h-[150px] w-auto max-w-full object-contain'
          }}

          {% if current_variant.metafields.custom.sticker != blank %}
            {{
              current_variant.metafields.custom.sticker
              | image_url: width: 148
              | image_tag: class: 'absolute top-0 -right-[30px] max-w-[74px]'
            }}
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div
      data-type="onetime"
      class="nl-product-variants__variant--price-widget flex flex-col items-center justify-center text-center gap-3 md:min-h-[127px]"
    >
      <div class="px-5 text-center">
        {% assign product_count_number = current_variant.metafields.custom.product_count_number %}
        <span class="text-[30px] md:text-[36px] font-bold text-black !leading-tight">
          {{- current_variant.price | divided_by: product_count_number | money -}}
          {% unless product_count_number == '1' %}
            <span class="text-[16px] md:text-[24px] font-normal"> / bottle</span>
          {% endunless %}
        </span>
      </div>

      {% if current_variant.metafields.custom.per_capsule != blank %}
        <div
          class="text-[14px] md:text-[16px] font-normal !leading-tight bg-[#EBA12F] w-fit text-center px-2 py-1 rounded-[5px] text-black"
        >
          <span class="font-bold">{{ current_variant.metafields.custom.per_capsule }}</span> per capsule
        </div>
      {% endif %}

      {% if current_variant.compare_at_price > current_variant.price %}
        <div class="px-5 flex flex-col items-center justify-center text-center gap-1">
          <div class="text-[20px] md:text-[24px] font-normal text-black !leading-tight">
            Total:
            <span class="font-regular text-[#00000080] line-through">
              {{- current_variant.compare_at_price | money -}}
            </span>
            <span class="font-medium">{{- current_variant.price | money -}}</span>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="px-5 w-full" {{ block.shopify_attributes }}>
      {%- if product != blank -%}
        {%- liquid
          assign gift_card_recipient_feature_active = false
          if block.settings.show_gift_card_recipient and product.gift_card?
            assign gift_card_recipient_feature_active = true
          endif

          assign show_dynamic_checkout = false
          if block.settings.show_dynamic_checkout and gift_card_recipient_feature_active == false
            assign show_dynamic_checkout = true
          endif
        -%}

        <product-form
          class="product-form !m-0 w-full"
          data-hide-errors="{{ gift_card_recipient_feature_active }}"
          data-section-id="{{ section.id }}"
        >
          <div class="product-form__error-message-wrapper" role="alert" hidden>
            <span class="svg-wrapper">
              {{- 'icon-error.svg' | inline_asset_content -}}
            </span>
            <span class="product-form__error-message"></span>
          </div>

          {%- form 'product',
            product,
            id: product_form_id,
            class: 'form w-full',
            novalidate: 'novalidate',
            data-type: 'add-to-cart-form'
          -%}
            <input
              type="hidden"
              name="id"
              value="{{ current_variant.id }}"
              {% if current_variant.available == false or quantity_rule_soldout %}
                disabled
              {% endif %}
              class="product-variant-id"
            >

            {%- if gift_card_recipient_feature_active -%}
              {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
            {%- endif -%}

            <div class="product-form__buttons">
              {%- liquid
                assign check_against_inventory = true
                if current_variant.inventory_management != 'shopify' or current_variant.inventory_policy == 'continue'
                  assign check_against_inventory = false
                endif
                if current_variant.quantity_rule.min > current_variant.inventory_quantity and check_against_inventory
                  assign quantity_rule_soldout = true
                endif
              -%}
              <button
                id="ProductSubmitButton-{{ section_id }}"
                type="submit"
                name="add"
                class="!m-0 !w-full product-form__submit button button--full-width {% if show_dynamic_checkout %}button--secondary{% else %}button--primary{% endif %} new-button--primary"
                {% if current_variant.available == false or quantity_rule_soldout or current_variant == null %}
                  disabled
                {% endif %}
              >
                <span>
                  {%- if current_variant == null -%}
                    {{ 'products.product.unavailable' | t }}
                  {%- elsif current_variant.available == false or quantity_rule_soldout -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- else -%}
                    {% if section.settings.button_label != blank %}
                      {{ section.settings.button_label }}
                      {% comment %} {{ current_variant.price | money_with_currency }} {% endcomment %}
                    {% else %}
                      {{ 'products.product.add_to_cart' | t }}
                    {% endif %}
                  {%- endif -%}
                </span>
                {%- render 'icon-arrow-right' -%}
                {%- render 'loading-spinner' -%}
              </button>
              {%- if show_dynamic_checkout -%}
                {{ form | payment_button }}
              {%- endif -%}
            </div>
          {%- endform -%}
        </product-form>
      {%- else -%}
        <div class="product-form">
          <div class="product-form__buttons form">
            <button
              type="submit"
              name="add"
              class="product-form__submit button button--full-width button--primary new-button--primary"
              disabled
            >
              {{ 'products.product.sold_out' | t }}
            </button>
          </div>
        </div>
      {%- endif -%}
    </div>

    {% assign total_text_count = 0 %}

    {% if current_variant.metafields.custom.bottom_text_1 != blank %}
      {% assign total_text_count = total_text_count | plus: 1 %}
    {% endif %}

    {% if current_variant.metafields.custom.bottom_text_2 != blank %}
      {% assign total_text_count = total_text_count | plus: 1 %}
    {% endif %}

    {% if current_variant.metafields.custom.bottom_text_3 != blank %}
      {% assign total_text_count = total_text_count | plus: 1 %}
    {% endif %}

    <div class="px-5 grid grid-cols-{{total_text_count}} items-center gap-2">
      {% if current_variant.metafields.custom.bottom_text_1 != blank %}
        <div class="flex gap-1 items-center justify-center">
          {% if current_variant.metafields.custom.bottom_icon_1 != blank %}
            {{ current_variant.metafields.custom.bottom_icon_1 | image_url: width: 20 | image_tag: class: '' }}
          {% endif %}
          <span class="text-[10px] md:text-[12px] font-normal text-black !leading-tight">
            {{- current_variant.metafields.custom.bottom_text_1 -}}
          </span>
        </div>
      {% endif %}

      {% if current_variant.metafields.custom.bottom_text_2 != blank %}
        <div class="flex gap-1 items-center justify-center">
          {% if current_variant.metafields.custom.bottom_icon_2 != blank %}
            {{ current_variant.metafields.custom.bottom_icon_2 | image_url: width: 20 | image_tag: class: '' }}
          {% endif %}
          <span class="text-[10px] md:text-[12px] font-normal text-black !leading-tight">
            {{- current_variant.metafields.custom.bottom_text_2 -}}
          </span>
        </div>
      {% endif %}

      {% if current_variant.metafields.custom.bottom_text_3 != blank %}
        <div class="flex gap-1 items-center justify-center">
          {% if current_variant.metafields.custom.bottom_icon_3 != blank %}
            {{ current_variant.metafields.custom.bottom_icon_3 | image_url: width: 20 | image_tag: class: '' }}
          {% endif %}
          <span class="text-[10px] md:text-[12px] font-normal text-black !leading-tight">
            {{- current_variant.metafields.custom.bottom_text_3 -}}
          </span>
        </div>
      {% endif %}
    </div>

    {% if current_variant.metafields.custom.ordered_count_text != blank %}
      <div
        class="px-5 mx-auto text-[12px] md:text-[12px] font-medium !leading-tight {% if index == section.settings.default_index %} bg-[#EBA12F] {% endif %} w-fit text-center px-2 py-1 rounded-[100px] text-black flex items-center gap-2"
      >
        {% render 'shipping-cart-green' %}
        <span>{{ current_variant.metafields.custom.ordered_count_text }}</span>
      </div>
    {% endif %}
  </div>
</div>
